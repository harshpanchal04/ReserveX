name: CD Pipeline - K3s

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to EC2 (K3s)
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # 1. Setup SSH & Copy Manifests
      # ----------------------------------------------------
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts

      - name: Copy Kubernetes Manifests
        run: |
          # Create target directory on server
          ssh -i ~/.ssh/id_rsa  -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} "mkdir -p ~/k8s"
          # Copy all yaml files
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no k8s/*.yaml ubuntu@${{ secrets.EC2_HOST }}:~/k8s/

      # ----------------------------------------------------
      # 2. Deploy to K3s Cluster
      # ----------------------------------------------------
      - name: Deploy to K3s
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -e
            echo "üöÄ Starting Deployment to K3s..."
            
            # Pull latest Docker image
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/reservex:latest
            
            # Apply Kubernetes manifests
            # Note: We assume K3s runs locally and ~/.kube/config is set (by setup_server.sh)
            kubectl apply -f ~/k8s/deployment.yaml
            kubectl apply -f ~/k8s/service.yaml
            
            # Force restart to pick up new image (since tag is 'latest')
            kubectl rollout restart deployment/reservex-deployment
            
            # Wait for rollout
            echo "‚è≥ Waiting for rollout..."
            kubectl rollout status deployment/reservex-deployment --timeout=120s
            
            # Verify
            echo "üìä Pod Status:"
            kubectl get pods -o wide
            
            echo "‚úÖ Deployment Complete"

      # ----------------------------------------------------
      # 3. Validation (DAST / Smoke Test)
      # ----------------------------------------------------
      - name: E2E Smoke Test
        run: |
          echo "üß™ Running E2E Check..."
          APP_URL="http://${{ secrets.EC2_HOST }}:30001"
          
          echo "Target: $APP_URL"
          sleep 10 # Give K3s a moment to route traffic
          
          # 1. Connectivity
          if curl -s -f "$APP_URL"; then
             echo "‚úÖ App is reachable"
          else
             echo "‚ùå App Unreachable"
             exit 1
          fi
          
          # 2. Security Headers (Simulated DAST)
          HEADERS=$(curl -sI "$APP_URL")
          echo "$HEADERS" | grep -i "server" && echo "‚ÑπÔ∏è Server header verified"

