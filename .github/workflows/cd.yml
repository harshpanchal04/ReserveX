name: CD Pipeline - K3s

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to EC2 (K3s)
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # Single-Step Robust Deployment (All-in-One SSH)
      # ----------------------------------------------------
      - name: Bootstrap & Deploy to K3s
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          # High timeout to allow for first-time installation (5m)
          timeout: 300s 
          command_timeout: 300s
          script: |
            set -e
            echo "üöÄ Starting Emergency Deployment (K3s)..."
            
            # --- PHASE 1: BOOTSTRAP (Install if Missing) ---
            if ! command -v k3s &> /dev/null; then
                echo "‚ö†Ô∏è K3s not found. Installing..."
                curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--disable=traefik" sh -
                
                # Setup permissions for 'ubuntu' user immediately
                mkdir -p ~/.kube
                sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
                sudo chown ubuntu:ubuntu ~/.kube/config
                sudo chmod 644 ~/.kube/config
                echo 'export KUBECONFIG=~/.kube/config' >> ~/.bashrc
            else
                echo "‚úÖ K3s is already installed."
            fi
            
            # Ensure permissions are correct for this session
            export KUBECONFIG=~/.kube/config
            
            # Open Firewall Ports (Idempotent)
            if ! sudo ufw status | grep -q "30001"; then
               sudo ufw allow 30001/tcp
               sudo ufw allow 6443/tcp
               # Ensure SSH is never locked out
               sudo ufw allow 22/tcp 
               sudo ufw --force enable
            fi

            # --- PHASE 2: DEPLOYMENT ---
            echo "üì¶ Deploying Application..."
            
            # 1. Pull Image (Pre-pull to speed up K8s)
            # Check if docker is present (K3s usually includes containerd, but we might want standard docker tools)
            # Actually, K3s uses containerd. We don't need 'docker pull' unless we use the docker CLI.
            # We will rely on K3s to pull the image.
            
            # 2. Write Manifests (Inline to avoid SCP connection issues)
            mkdir -p ~/k8s
            
            cat << 'EOF' > ~/k8s/deployment.yaml
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              name: reservex-deployment
              namespace: default
              labels:
                app: reservex
            spec:
              replicas: 2
              selector:
                matchLabels:
                  app: reservex
              template:
                metadata:
                  labels:
                    app: reservex
                spec:
                  containers:
                  - name: reservex
                    image: ${{ secrets.DOCKERHUB_USERNAME }}/reservex:latest
                    imagePullPolicy: Always
                    ports:
                    - containerPort: 8501
            EOF
            
            cat << 'EOF' > ~/k8s/service.yaml
            apiVersion: v1
            kind: Service
            metadata:
              name: reservex-service
              namespace: default
            spec:
              type: NodePort
              selector:
                app: reservex
              ports:
              - protocol: TCP
                port: 8501
                targetPort: 8501
                nodePort: 30001
            EOF
            
            # 3. Apply
            kubectl apply -f ~/k8s/deployment.yaml
            kubectl apply -f ~/k8s/service.yaml
            
            # 4. Force Update
            kubectl rollout restart deployment/reservex-deployment
            
            # --- PHASE 3: VERIFICATION (Smoke Test) ---
            echo "‚è≥ Waiting for rollout..."
            kubectl rollout status deployment/reservex-deployment --timeout=120s
            
            echo "üß™ Running Smoke Test (Target: Port 30001)..."
            # Wait for pod to be ready and service to link
            sleep 10 
            
            APP_URL="http://localhost:30001"
            if curl -s -f "$APP_URL" > /dev/null; then
               echo "‚úÖ HEALTH CHECK PASSED: App is reachable on port 30001"
            else
               # Start debugging info but don't fail immediately, give it one more retry
               echo "‚ö†Ô∏è First check failed... retrying in 10s..."
               sleep 10
               if curl -s -f "$APP_URL" > /dev/null; then
                  echo "‚úÖ HEALTH CHECK PASSED (Retry)"
               else
                  echo "‚ùå HEALTH CHECK FAILED"
                  kubectl get pods -o wide
                  exit 1
               fi
            fi
            
            echo "üéâ Deployment Success!"

