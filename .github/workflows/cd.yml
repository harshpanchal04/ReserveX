name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed

jobs:
  deploy:
    # Only deploy if CI succeeded on main/master branch
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'master')

    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------------
      # 1. Checkout (for reference, though we use remote scripts)
      # ----------------------------------------------------
      - name: Checkout source code
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # 2. Deploy to Kubernetes (EC2 + Minikube)
      # ----------------------------------------------------
      - name: Deploy to Kubernetes Cluster
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # Ensure Docker and Minikube are running
            # (Assumes pre-installed environment. If not, add install scripts here)
            if ! minikube status | grep -q "Running"; then
              minikube start --driver=docker --force
            fi
            
            # Pull latest image
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/reservex:latest
            
            # Load image into Minikube's Docker daemon
            minikube image load ${{ secrets.DOCKERHUB_USERNAME }}/reservex:latest
            
            # Create Deployment Manifest
            cat << 'DEPLOYMENT_EOF' > /tmp/deployment.yaml
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              name: reservex-deployment
              labels:
                app: reservex
            spec:
              replicas: 2
              selector:
                matchLabels:
                  app: reservex
              template:
                metadata:
                  labels:
                    app: reservex
                spec:
                  containers:
                  - name: reservex
                    image: ${{ secrets.DOCKERHUB_USERNAME }}/reservex:latest
                    imagePullPolicy: Never
                    ports:
                    - containerPort: 8501
            DEPLOYMENT_EOF
            
            # Create Service Manifest
            cat << 'SERVICE_EOF' > /tmp/service.yaml
            apiVersion: v1
            kind: Service
            metadata:
              name: reservex-service
            spec:
              type: NodePort
              selector:
                app: reservex
              ports:
              - protocol: TCP
                port: 8501
                targetPort: 8501
                nodePort: 30001
            SERVICE_EOF
            
            # Apply Manifests
            kubectl apply -f /tmp/deployment.yaml
            kubectl apply -f /tmp/service.yaml
            
            # Wait for Rollout
            kubectl rollout status deployment/reservex-deployment --timeout=120s
            
            # Verify Pods
            kubectl get pods -l app=reservex
            
            echo "âœ… Kubernetes deployment completed!"

      # ----------------------------------------------------
      # 3. Dummy DAST - Security Scan
      # ----------------------------------------------------
      - name: Dummy DAST - Security Scan
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            echo "ðŸ” Starting DAST (Dynamic Application Security Testing)..."
            
            # Get Minikube IP
            MINIKUBE_IP=$(minikube ip)
            APP_URL="http://${MINIKUBE_IP}:30001"
            
            echo "Testing application at: ${APP_URL}"
            
            # Wait for service to be ready
            sleep 10
            
            # Test 1: Health Check (Basic Connectivity)
            echo "Test 1: Connectivity Check"
            curl -sf "${APP_URL}" > /dev/null && echo "âœ… Application is reachable" || echo "âš ï¸ Application unreachable"
            
            # Test 2: HTTP Methods
            echo "Test 2: HTTP Methods"
            curl -sX OPTIONS "${APP_URL}" -I 2>/dev/null | head -n 1
            
            # Test 3: Security Headers (Basic Check)
            echo "Test 3: Security Headers"
            HEADERS=$(curl -sI "${APP_URL}")
            echo "$HEADERS" | grep -qi "server" && echo "âœ… Server header present" || echo "Note: Server header hidden (Good)"
            
            echo ""
            echo "âœ… DAST Security Scan completed!"
